version: 2
jobs:
  build:
    docker:
      - image: haskell:latest

    steps:
      - checkout

      - run:
          name: Compile
          command: stack build

      - run:
          name: Install
          command: stack install

      - run:
          name: Install scp
          command: apt update; apt install -y openssh-client

      - run:
          name: Add server to known_hosts
          command: ssh-keyscan $SERVER_IP >> ~/.ssh/known_hosts

      - run:
          name: Push to VPS
          command: scp /root/.local/bin/koscbot-exe $USERNAME@$SERVER_IP:$SERVER_PATH

      - run:
          name: Restart bot
          command: ssh $USERNAME@$SERVER_IP "killall koscbot-exe && ./koscbot-exe &"
